import{r as m}from"./index.cb8fb047.js";import{j as i,c as g,a as N,u as y,o as P,d as S,s as k,E as C}from"./EditionDot.abe84bd5.js";function b(r){return r.replace(/\s+/g,"_").toLowerCase()}function A({source:r,unit:e}){const t=n=>{const s=n.target.value,o=g.filter(l=>l.label===n.target.value)[0],a=g.find(l=>l.label==r).units.find(l=>l.id==e).chunks[0].label;if(o){const l=N.get(),d=g.find(h=>h.label===s).units.find(h=>h.chunks.find(u=>u.label==a&&u.apps[0]<=l&&l<=u.apps[1]))?.id||g.find(h=>h.label===s).units[0].id,c=`/viewer/${s}/${b(d)}`;window.location.replace(c)}};return i.jsx("div",{children:i.jsxs("form",{method:"get",action:"viewer",children:[i.jsx("label",{className:"bold-choose",children:"CHOOSE A VERSION"}),i.jsx("select",{className:"select-style",name:"tei",value:r,onChange:t,children:g.map(n=>i.jsx("option",{className:n.label,value:n.label,children:n.label},n.label))})]})})}function $(){const r=m.useRef([]),e=m.useRef([]),t=y(k);return m.useEffect(()=>{r.current=[...document.querySelectorAll("tei-seg")],e.current=[...document.querySelectorAll("tei-p")]},[]),m.useEffect(()=>{(r.current||!t[3])&&(r.current.forEach(n=>{n.classList.toggle("tei-cdata",!t.showText),n.classList.toggle("no-text",!t.showText)}),e.current.forEach(n=>{n.classList.toggle("tei-cdata",!t.showText),n.classList.toggle("no-text",!t.showText)}))},[t]),i.jsxs("div",{children:[i.jsx("label",{className:"options-label bold-choose",children:"CHOOSE OPTIONS"}),i.jsxs("label",{className:"options-label",children:[i.jsx("input",{name:"variation",type:"checkbox",checked:t.showVariants,onChange:P}),"See Variants"]}),i.jsxs("label",{className:"options-label",children:[i.jsx("input",{name:"text",type:"checkbox",checked:t.showText,onChange:S}),"See Text"]})]})}function M({source:r,unit:e}){const[t,n]=m.useState(0),s=g.filter(c=>c.label===r).flatMap(c=>c.units.map(h=>h.id));m.useEffect(()=>{const c=window.location.pathname.split("/"),h=c[c.length-1].split("#")[0],u=s.findIndex(j=>j===h);n(u)},[r]);const o=()=>{if(t>0){const c=t-1;n(c);const h=`/viewer/${r}/${s[c]}`;window.location.replace(h)}},a=()=>{if(t<s.length-1){const c=t+1;n(c);const h=`/viewer/${r}/${s[c]}`;window.location.replace(h)}},l=g.filter(c=>c.label===r)[0],d=c=>{const h=c.target.value,u=`/viewer/${r}/${b(h)}`;window.location.replace(u)};return i.jsx("div",{children:i.jsxs("div",{className:"paging",children:[i.jsx("div",{className:"in-line",children:i.jsxs("form",{method:"get",children:[i.jsx("label",{className:"bold-choose",children:"CHOOSE A SECTION"}),i.jsx("div",{className:"select-style css-yk16xz-control",children:i.jsx("div",{className:"css-1hwfws3",children:i.jsx("select",{className:"select-style",value:e,onChange:d,children:l.units.map(c=>i.jsx("option",{value:b(c.label),children:c.label},c.label))})})})]})}),i.jsxs("div",{className:"in-line paging-buttons",children:[i.jsx("button",{onClick:o,className:"prev",disabled:t<=0}),i.jsx("label",{children:"Previous Section"}),i.jsx("label",{className:"margin-button",children:"Next Section"}),i.jsx("button",{className:"next",onClick:a,disabled:t>=s.length-1})]})]})})}class z{_xmls;_promises;static documentCount=0;constructor(){this._xmls=new Map,this._promises=new Map}getXML(e){if(this._xmls.has(e))return Promise.resolve(this._xmls.get(e));if(this._promises.has(e))return this._promises.get(e);const t=this.fetchXML(e);return this._promises.set(e,t),t.then(()=>{this._promises.delete(e)}),t}parseXML(e){return new DOMParser().parseFromString(e,"text/xml")}async fetchXML(e){const n=await(await fetch(e)).text(),s=this.parseXML(n);return this._xmls.set(e,s),s}}class I{_jsons;_promises;static documentCount=0;constructor(){this._jsons=new Map,this._promises=new Map}getJSON(e){if(this._jsons.has(e))return Promise.resolve(this._jsons.get(e));if(this._promises.has(e))return this._promises.get(e);const t=this.fetchJson(e);return this._promises.set(e,t),t.then(()=>{this._promises.delete(e)}),t}async fetchJson(e){let n=await(await fetch(e)).json();return n.constructor===Array&&(n={json:n}),this._jsons.set(e,n),n}}function f(r,e){const t=r.createNSResolver(r.documentElement);try{r.evaluate(e,r,t)}catch(a){console.error(`xpath evaluation of ${e} failed: `,a)}const n=r.evaluate(e,r,t),s=[];let o=n.iterateNext();for(;o;)s.push(o),o=n.iterateNext();return s}function T(r,e){const n=`//*[@${e.startsWith("mock")?"mock-id":"xml:id"}="${e}"]`,s=f(r,n);if(s.length===0)throw Error(`Pointer ${e} references an invalid element`);if(s.length>1)throw Error(`Pointer ${e} references more than one element`);return s[0]}class E{code="";name="";chunks=[];constructor(e,t,n){this.code=e,this.name=t,this.chunks=n}getChunkUrl(e){const t=e<10?`0${e}`:`${e}`;return`https://raw.githubusercontent.com/PghFrankenstein/fv-data/master/variorum-chunks/f${this.code}_C${t}.xml`}async getXML(e){return await p.cache.getXML(this.getChunkUrl(e))}getMarginRootElements(e){return[]}}class w extends E{getMainRootElements(e){try{return[e.getElementsByTagName("body")[0]]}catch(t){throw console.error(`Can't located body element of ${this.code}: ${t}`),new Error("Can't locate body element")}}}class L extends E{getMainRootElements(e){return f(e,"//tei:zone[@type='main']").map(s=>s)}getMarginRootElements(e){return f(e,"//tei:zone[@type='left_margin']").map(s=>s)}}class R{constructor(e,t){this.grpElement=t,this.groupId=t.getAttribute("xml:id"),this.apparatus=e,this.editions=this.fillEditions(),this.pointers=this.fillPointers(),this.element=this.buildElement()}groupId;editions;apparatus;element;pointers;fillEditions(){return Array.from(this.grpElement.getElementsByTagName("rdg")).map(s=>s.getAttribute("wit").substr(2)).map(s=>p.editions.find(o=>o.code===s))}fillPointers(){const e=this.editions[0];return this.apparatus.pointers.filter(t=>t.groupId===this.groupId&&t.edition===e)}buildElement(){if(this.pointers.length===0)return;const e=document.implementation.createDocument(null,null,null),t=e.createElement("rdgGrp"),n=this.pointers.map(s=>s.dereferenced);for(const s of n){const o=s.cloneNode(!0);t.appendChild(o)}return e.appendChild(t),t}}class O{id;n;element;pointers;_groups;constructor(e){this.element=e;const t=e.attributes.getNamedItem("xml:id");if(!t)throw new Error("<app> tag with no xml:id");this.id=t.value;const n=e.attributes.getNamedItem("n");this.n=n?parseInt(n.value):void 0,this.pointers=this.parsePointers(),this._groups=[]}get groups(){return this._groups}buildGroups(){const e=Array.from(this.element.getElementsByTagName("rdgGrp"));this._groups=Array.from(e).map(t=>new R(this,t))}parsePointers(){return Array.from(this.element.getElementsByTagName("ptr")).map(n=>this.parsePointer(n))}parsePointer(e){const t=e.parentNode;if(!t||t.tagName!=="rdg")throw new Error("Parent of <ptr> is not <rdg>");const n=t.attributes.getNamedItem("wit");if(!n)throw new Error("<rdg> element does not have a wit attribute");const s=n.value.substr(2);let o;try{o=p.getEdition(s)}catch{throw new Error(`<rdg> has invalid witness ${n.value}`)}const a=t.parentNode;if(!a||a.tagName!=="rdgGrp")throw new Error("Parent of <rdg> element is not <rdgGrp>");const l=a.attributes.getNamedItem("xml:id");if(!l)throw new Error("<rdrGrp> has no xml:id");const d=l.value,c=e.attributes.getNamedItem("target");if(!c)throw new Error("<ptr> element has not target attribute");const h=c.value.split("#");if(h.length!==2)throw new Error(`Target ${c.value} is not well formatted. Expected uri#xpath`);return{ptrElement:e,edition:o,groupId:d,referencedUrl:h[0],referencedTarget:h[1]}}getOtherGroups(e){return this.groups.filter(t=>t.editions.indexOf(e)===-1)}}class v{chunkNumber;_apps;_xml;_initialized=!1;_initializationPromise;static mockElementCount=0;constructor(e){this.chunkNumber=e}initialize(){return this._initializationPromise?this._initializationPromise:(this._initializationPromise=this.innerInitialize(),this._initializationPromise.then(()=>{this._initializationPromise=void 0}),this._initializationPromise)}async innerInitialize(){this._initialized||(this._xml=await this.getXML(),await this.parseApps(),await this.fetchAllReferences(),await this.rewriteStringRanges(),await this.dereferencePointers(),this.addBackPointers(),this.buildGroupsInApps(),this._initialized=!0)}async getXML(){const t=`https://raw.githubusercontent.com/PghFrankenstein/fv-data/master/standoff_Spine/spine_C${this.chunkNumber<10?`0${this.chunkNumber}`:`${this.chunkNumber}`}.xml`;return await p.cache.getXML(t)}async parseApps(){if(!this._xml)throw new Error("parseApps called before getXML, which makes no sense");const t=Array.from(this._xml.getElementsByTagName("app")).map(n=>new O(n));this._apps=t}get apps(){if(!this._apps)throw new Error("Spine not initialized yet");return this._apps}async fetchAllReferences(){let e=[];for(let s of this.apps){const o=s.pointers.map(a=>a.referencedUrl);e=e.concat(o)}const n=Array.from(new Set(e)).map(s=>p.cache.getXML(s));await Promise.all(n)}async rewriteStringRanges(){const e=/^string-range\((?<xpath>.+),(?<start>\d+),(?<length>\d+)\)$/;for(let t of this.apps){const n=new Set;for(let o of t.pointers){const a=o.referencedTarget.match(e);if(a){const l={xpath:a.groups.xpath,start:parseInt(a.groups.start),length:parseInt(a.groups.length)};try{await this.rewriteStringRange(o,l)}catch{n.add(o)}}}const s=t.pointers.filter(o=>!n.has(o));t.pointers=s}}async rewriteStringRange(e,t){const n=await p.cache.getXML(e.referencedUrl),s=f(n,t.xpath);if(s.length===0)throw console.error(`string-range for xpath ${t.xpath} failed to return a node`),Error("string-range returned no nodes");if(s.length>1)throw console.error(`string-range for xpath ${t.xpath} returned more than one node`),Error("string-range returned more than one node");const o=s[0],a=o.attributes.getNamedItem("xml:id"),l=o.attributes.getNamedItem("mock-id");let d="";a?d=a.value:l?d=l.value:(d=`mock-id-${v.mockElementCount}`,v.mockElementCount+=1,o.setAttribute("mock-id",d)),e.referencedTarget=d,e.ptrElement.setAttribute("target",`${e.referencedUrl}#${d}`)}async dereferencePointers(){for(let e of this.apps){const t=new Set;for(let s of e.pointers){const o=await p.cache.getXML(s.referencedUrl);try{const a=T(o,s.referencedTarget);s.dereferenced=a}catch{console.error(`Pointer ${s.ptrElement.outerHTML} is invalid`),t.add(s)}}const n=e.pointers.filter(s=>!t.has(s));e.pointers=n}}addBackPointers(){for(let e of this.apps){const t=new Set;for(let n of e.pointers){if(!n.dereferenced){console.error("Non dereferenced pointed in addBackPointers - pointers should all be dereferenced by now");continue}const s=!t.has(n.referencedUrl);n.dereferenced.setAttribute("app-ref",e.id),n.dereferenced.setAttribute("first-in-app",s?"true":"false"),t.add(n.referencedUrl)}}}buildGroupsInApps(){for(const e of this.apps)e.buildGroups()}}class x{editionCode;chunkNumber;_json;_initialized=!1;_initializationPromise;constructor(e,t){this.editionCode=e,this.chunkNumber=t}initialize(){return this._initializationPromise?this._initializationPromise:(this._initializationPromise=this.innerInitialize(),this._initializationPromise.then(()=>{this._initializationPromise=void 0}),this._initializationPromise)}async innerInitialize(){this._initialized||(this._json=await this.getJSON(),await this.parsePointers(),this._initialized=!0)}async getJSON(){const e=`https://raw.githubusercontent.com/FrankensteinVariorum/fv-data/master/hypothesis/openannotation/${this.editionCode}_xml_id_mapping.json`;return await p.jcache.getJSON(e)}async parsePointers(){const e=this.chunkNumber<10?`0${this.chunkNumber}`:`${this.chunkNumber}`,t=await p.cache.getXML(`https://raw.githubusercontent.com/PghFrankenstein/fv-data/master/variorum-chunks/f${this.editionCode}_C${e}.xml`);this._json.json.map(n=>this.parsePointer(n,t))}parsePointer(e,t){const s=e.target.selector.filter(a=>a.type==="RangeSelector")[0].startSelector.value,o=f(t,s);if(o.length>0){const a=o[0],l=a.getAttribute("annotatedBy");l?a.setAttribute("annotatedBy",`${l} ${e.id}`):a.setAttribute("annotatedBy",e.id)}return s}getAnnotation(e){return this._json.json.filter(n=>n.id===e)[0]}}class _{cache;jcache;editions;spines;annotations;static instance=new _;constructor(){this.cache=new z,this.jcache=new I,this.editions=[new L("MS","MS",[7,8,9,10]),new w("1818","1818",[1,2,3,4,5,6,7,8,9,10]),new w("Thomas","Thomas",[1,2,3,4,5,6,7,8,9,10]),new w("1823","1823",[1,2,3,4,5,6,7,8,9,10]),new w("1831","1831",[1,2,3,4,5,6,7,8,9,10])],this.spines=[1,2,3,4,5,6,7,8,9,10].map(e=>new v(e)),this.annotations=[1,2,3,4,5,6,7,8,9,10].map(e=>new x("1818",e)).concat([1,2,3,4,5,6,7,8,9,10].map(e=>new x("1823",e)),[1,2,3,4,5,6,7,8,9,10].map(e=>new x("1831",e)),[1,2,3,4,5,6,7,8,9,10].map(e=>new x("Thomas",e)))}getEdition(e){const t=this.editions.find(n=>n.code===e);if(!t)throw new Error(`Can't find edition ${e}`);return t}getSpine(e){const t=this.spines.find(n=>n.chunkNumber===e);if(!t)throw new Error(`Can't find spine for chunk ${e}`);return t}getAnnotation(e,t){const n=this.annotations.find(s=>s.editionCode===e&&s.chunkNumber===t);if(!n)throw new Error(`Can't find annotations for edition ${e}`);return n}}const X=_.instance,p=X,U={src:"/_astro/sgalogo.ce4ab912.png",width:248,height:140,format:"png"},B={src:"/_astro/intensity_legend.50aa66db.svg",width:240,height:30,format:"svg"};function G({edition:r}){const e=p.editions.map((n,s)=>i.jsxs("label",{className:"edition-label",children:[i.jsx(C,{edition:n.name},n.name),n.name]},s));let t;return r&&r==="MS"&&(t=i.jsxs("div",{id:"sga",children:[i.jsx("a",{href:"http://shelleygodwinarchive.org/sc/oxford/frankenstein/volume/iii/#/p30",children:i.jsx("img",{src:U.src})}),i.jsxs("div",{children:["View the manuscript facsimile, transcription and more on the ",i.jsx("a",{href:"http://shelleygodwinarchive.org/sc/oxford/frankenstein/volume/iii/#/p30",children:"Shelley-Godwin Archive"})]}),i.jsx("hr",{})]})),i.jsxs("div",{id:"header",children:[i.jsxs("header",{className:"viewer__cols",children:[i.jsx("div",{id:"viewer__legend-editions",children:e}),i.jsx("div",{id:"viewer__title",className:"center-label",children:r?i.jsxs("h2",{children:[r," Edition"]}):i.jsx("h2",{children:"Edition"})}),i.jsxs("div",{id:"viewer__legend-variance",children:[i.jsx("label",{children:"Amount of Variance"}),i.jsx("img",{className:"variations",src:B.src,alt:"variations scale"})]})]}),i.jsx("hr",{className:"line"}),i.jsxs("div",{className:"viewer__cols",children:[i.jsx("div",{className:"center-label",children:"Marginalia"}),i.jsx("div",{className:"center-label",children:"Text"}),i.jsx("div",{className:"center-label",children:"Variations"})]}),t]})}function J(){const[r,e]=m.useState("1818"),[t,n]=m.useState();return m.useEffect(()=>{const[s,o,a,l]=window.location.pathname.split("/");e(a),n(l)},[]),i.jsxs(i.Fragment,{children:[i.jsxs("div",{id:"viewer__controls",children:[i.jsx(A,{source:r,unit:t}),i.jsx(M,{unit:t,source:r}),i.jsx($,{})]}),i.jsx(G,{edition:r})]})}export{J as default};
